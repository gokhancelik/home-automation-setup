apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: home-assistant
  namespace: home-automation
spec:
  interval: 5m
  chart:
    spec:
      chart: ./charts/home-assistant
      sourceRef:
        kind: GitRepository
        name: flux-system
        namespace: flux-system
      version: 1.0.16
      interval: 1m
  values:
    image:
      repository: homeassistant/home-assistant
      tag: "2025.8.3"
      pullPolicy: IfNotPresent
    
    homeAssistant:
      configuration: |
        # Loads default set of integrations. Do not remove.
        default_config:

        # Core configuration
        homeassistant:
          name: Home
          latitude: !secret latitude
          longitude: !secret longitude
          elevation: 0
          unit_system: metric
          time_zone: !secret timezone
          country: NL
          external_url: https://ha.gcelik.dev
          internal_url: http://home-assistant.home-automation.svc.cluster.local:8123

        # HTTP configuration
        http:
          use_x_forwarded_for: true
          trusted_proxies:
            - 10.0.0.0/8
            - 172.16.0.0/12
            - 192.168.0.0/16
          server_host: 0.0.0.0
          server_port: 8123

        # HACS (Home Assistant Community Store)
        # After installation, go to Configuration -> Integrations and add HACS
        # You'll need a GitHub Personal Access Token for HACS setup

        # Frontend configuration for HACS
        frontend:
          themes: !include_dir_merge_named themes


        # HomeKit Bridge - Expose Home Assistant devices to Apple HomeKit
        # This allows Zigbee devices (like Aqara FP2) to work with HomeKit
        homekit:
          - name: "Home Assistant Bridge"
            port: 21063
            filter:
              include_domains:
                - light
                - switch
                - sensor
                - binary_sensor
                - climate
                - cover
                - fan
                - lock
                - media_player
              exclude_entities:
                # Exclude noisy sensors that shouldn't be in HomeKit
                - sensor.uptime
                - sensor.date
                - sensor.time

        # InfluxDB v2 integration for time-series data
        influxdb:
          api_version: 2
          host: influxdb-influxdb2.data-storage.svc.cluster.local
          port: 8086
          ssl: false
          verify_ssl: false
          token: !secret influxdb_token
          organization: home-automation
          bucket: home-assistant
          max_retries: 3
          default_measurement: state
          exclude:
            entities:
              - zone.home
            domains:
              - automation
              - updater
          include:
            domains:
              - sensor
              - binary_sensor
              - switch
              - light
              - device_tracker
              - climate
              - weather

        # Recorder (local database)
        recorder:
          purge_keep_days: 1
          commit_interval: 5
          db_url: "sqlite:////config/home-assistant_v2.db"
          include:
            domains:
              - automation
              - script
              - person
              - updater
            entity_globs:
              - "automation.*"
              - "script.*"

        # Logger configuration
        logger:
          default: info

        # Automation
        automation: !include automations.yaml

        # Scripts
        script: !include scripts.yaml

        # Scenes
        scene: !include scenes.yaml

    secretRef:
      name: home-assistant-config

    env:
      TZ: "Europe/Amsterdam"

    ingress:
      enabled: true
      className: nginx
      host: ha.gcelik.dev
      tls:
        enabled: true
        secretName: home-assistant-tls

    persistence:
      enabled: true
      size: 5Gi
      storageClass: ssd-storage

    resources:
      requests:
        cpu: 200m
        memory: 512Mi
      limits:
        cpu: 1000m
        memory: 2Gi
