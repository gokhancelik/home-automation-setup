image:
  repository: homeassistant/home-assistant
  tag: "2025.12.3"
  pullPolicy: IfNotPresent

# Networking configuration
networking:
  hostNetwork: true
  dnsPolicy: ClusterFirstWithHostNet

# Security context - only fsGroup to allow init containers to write files
securityContext:
  fsGroup: 1000

homeAssistant:
  configuration: |
    # Loads default set of integrations. Do not remove.
    default_config:

    # Core configuration
    homeassistant:
      name: Home
      latitude: !secret latitude
      longitude: !secret longitude
      elevation: 0
      unit_system: metric
      time_zone: !secret timezone
      country: NL
      external_url: https://ha.gcelik.dev
      internal_url: http://home-assistant.home-automation.svc.cluster.local:8123

    # HTTP configuration
    http:
      use_x_forwarded_for: true
      trusted_proxies:
        - 10.0.0.0/8
        - 172.16.0.0/12
        - 192.168.0.0/16
      server_host: 0.0.0.0
      server_port: 8123

    # HACS (Home Assistant Community Store)
    # After installation, go to Configuration -> Integrations and add HACS
    # You'll need a GitHub Personal Access Token for HACS setup

    # Frontend configuration for HACS
    frontend:
      themes: !include_dir_merge_named themes

    # MQTT integration is configured via UI (Settings â†’ Devices & Services)
    # Broker: localhost:1883 (Mosquitto with hostNetwork)

    # InfluxDB v2 integration for long-term time-series data
    # Retention: Infinite (multi-year) - suitable for energy/climate analysis
    influxdb:
      api_version: 2
      host: influxdb-influxdb2.data-storage.svc.cluster.local
      port: 8086
      ssl: false
      verify_ssl: false
      token: !secret influxdb_token
      organization: home-automation
      bucket: home-assistant
      max_retries: 3
      default_measurement: state
      # Tags for better querying and organization
      tags:
        source: home-assistant
        location: home
      tags_attributes:
        - friendly_name
        - device_class
      # Exclude non-useful data from long-term storage
      exclude:
        entities:
          - zone.home
          - sun.sun
        domains:
          - automation
          - updater
          - script
          - group
      # Include valuable long-term metrics
      include:
        domains:
          - sensor
          - binary_sensor
          - switch
          - light
          - device_tracker
          - climate
          - weather
        entity_globs:
          - sensor.*_energy
          - sensor.*_power
          - sensor.*_temperature
          - sensor.*_humidity
          - sensor.*_battery
          - sensor.*_voltage

    # Recorder (PostgreSQL database)
    recorder:
      purge_keep_days: 30
      commit_interval: 1
      db_url: !secret postgresql_url
      exclude:
        domains:
          - automation
          - updater
        entities:
          - sun.sun
          - weather.forecast_home

    # History
    history:
      include:
        domains:
          - sensor
          - switch
          - light
          - binary_sensor
          - device_tracker
          - climate

    # Logger configuration
    logger:
      default: info

    # Automation
    automation: !include automations.yaml

    # Scripts
    script: !include scripts.yaml

    # Scenes
    scene: !include scenes.yaml

    # Matter integration (experimental)
    # Matter server runs in separate namespace for isolation
    # Connection: ws://matter-server.matter.svc.cluster.local:5580/ws
    # To configure Matter integration, go to:
    # Configuration -> Integrations -> Add Integration -> Matter (BETA)
    # Use the URL above when prompted for the Matter server address

secretRef:
  name: home-assistant-config

env:
  TZ: "Europe/Amsterdam"

ingress:
  enabled: true
  className: nginx
  host: ha.gcelik.dev
  tls:
    enabled: true
    secretName: home-assistant-tls

persistence:
  enabled: true
  size: 5Gi
  storageClass: nfs-storage

resources:
  requests:
    cpu: 200m
    memory: 512Mi
  limits:
    cpu: 1000m
    memory: 2Gi
